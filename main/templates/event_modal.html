<div id="event-modal" class="hidden fixed inset-0 z-50 w-full h-full flex items-center justify-center bg-black bg-opacity-70 font-['Plus_Jakarta_Sans']">
  <div class="bg-[#353535] backdrop-blur-lg rounded-2xl border border-white/20 w-11/12 md:w-1/2 max-h-[90vh] overflow-y-auto">
    
    <div class="flex items-center justify-between p-4 border-b border-white/20">
      <h3 id="modal-title" class="text-xl font-semibold text-white">Formulir Event</h3>
      <button type="button" class="text-gray-400 bg-transparent hover:text-white rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideEventModal()">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        <span class="sr-only">Tutup modal</span>
      </button>
    </div>
    
    <div class="px-6 py-4">
      <form id="event-form" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" id="form-event-id" name="event_id">
        <div id="form-errors" class="hidden mb-4"></div>
        
        <div>
          <label for="form-nama" class="block text-sm font-medium text-gray-300 mb-1">Nama Event</label>
          <input type="text" id="form-nama" name="nama" required class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors">
        </div>
        
        <div>
          <label for="form-olahraga" class="block text-sm font-medium text-gray-300 mb-1">Cabang Olahraga</label>
          <select id="form-olahraga" name="olahraga" required class="w-full px-4 py-3 bg-[#353535] border border-white/20 rounded-md text-white focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors appearance-none">
            <option value="sepakbola">Sepak Bola</option>
            <option value="basket">Basket</option>
            <option value="voli">Voli</option>
            <option value="badminton">Badminton</option>
            <option value="tenis">Tenis</option>
            <option value="futsal">Futsal</option>
            <option value="padel">Padel</option>
            <option value="golf">Golf</option>
            <option value="lainnya">Lainnya</option>
          </select>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="form-tanggal" class="block text-sm font-medium text-gray-300 mb-1">Tanggal</label>
              <input type="date" id="form-tanggal" name="tanggal" required class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors">
            </div>
            <div>
              <label for="form-jam" class="block text-sm font-medium text-gray-300 mb-1">Jam (Opsional)</label>
              <input type="time" id="form-jam" name="jam" class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors">
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="form-lokasi" class="block text-sm font-medium text-gray-300 mb-1">Lokasi</label>
              <input type="text" id="form-lokasi" name="lokasi" required class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors">
            </div>
             <div>
              <label for="form-kontak" class="block text-sm font-medium text-gray-300 mb-1">Kontak</label>
              <input type="text" id="form-kontak" name="kontak" required class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors">
            </div>
        </div>

        <div>
          <label for="form-deskripsi" class="block text-sm font-medium text-gray-300 mb-1">Deskripsi</label>
          <textarea id="form-deskripsi" name="deskripsi" rows="3" required class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors"></textarea>
        </div>
        
        <div>
          <label for="form-thumbnail" class="block text-sm font-medium text-gray-300 mb-1">URL Gambar (Opsional)</label>
          <input type="url" id="form-thumbnail" name="thumbnail" class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors">
        </div>

        <div>
          <label for="form-biaya" class="block text-sm font-medium text-gray-300 mb-1">Biaya (Isi 0 jika gratis)</label>
          <input type="number" id="form-biaya" name="biaya" required class="w-full px-4 py-3 bg-white/5 border border-white/20 rounded-md text-white placeholder:text-gray-400 focus:outline-none focus:border-2 focus:border-[#06005E] transition-colors" placeholder="0" value="0">
        </div>
        </form>
    </div>
    
    <div class="flex items-center justify-end p-6 border-t border-white/20 rounded-b">
      <button type="button" class="px-6 py-2 border border-gray-500 text-gray-300 rounded-md font-medium hover:bg-gray-700 transition-colors" onclick="hideEventModal()">Batal</button>
      <button type="submit" form="event-form" class="ml-3 bg-gradient-to-r from-[#06005E] to-[#571E88] hover:from-[#1A107A] hover:to-[#7A3EAA] text-white font-semibold py-2 px-6 rounded-md transition-colors duration-300">Simpan</button>
    </div>
  </div>
</div>

<script>
  const eventModal = document.getElementById('event-modal');
  const modalTitle = document.getElementById('modal-title');
  const eventForm = document.getElementById('event-form');
  const formErrors = document.getElementById('form-errors');
  
  function showCreateEventModal() {
      eventForm.reset();
      modalTitle.textContent = "Buat Event Baru";
      document.getElementById('form-event-id').value = '';
      formErrors.innerHTML = '';
      formErrors.classList.add('hidden');
      eventModal.classList.remove('hidden');
  }

  async function showEditEventModal(eventId) {
      eventForm.reset();
      modalTitle.textContent = "Edit Event";
      formErrors.innerHTML = '';
      formErrors.classList.add('hidden');

      try {
          const response = await fetch(`/get-event-ajax/${eventId}/`); 
        
          if (!response.ok) {
              throw new Error(`Server error: ${response.status}`);
          }

          const result = await response.json();

          if (result.status === 'success') {
              const data = result.data;
              document.getElementById('form-event-id').value = eventId;
              document.getElementById('form-nama').value = data.nama;
              document.getElementById('form-olahraga').value = data.olahraga;
              document.getElementById('form-tanggal').value = data.tanggal;
              document.getElementById('form-jam').value = data.jam;
              document.getElementById('form-lokasi').value = data.lokasi;
              document.getElementById('form-kontak').value = data.kontak;
              document.getElementById('form-deskripsi').value = data.deskripsi;
              document.getElementById('form-thumbnail').value = data.thumbnail;
              document.getElementById('form-biaya').value = data.biaya;
              eventModal.classList.remove('hidden');
          } else {
              console.error(result.message || 'Gagal mengambil data event.');
          }
      } catch (error) {
          console.error('Terjadi kesalahan saat mengambil data.', error);
      }
  }

  function hideEventModal() {
      eventModal.classList.add('hidden');
  }

  eventForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      formErrors.innerHTML = '';
      formErrors.classList.add('hidden');

      const eventId = document.getElementById('form-event-id').value;
      const isEdit = eventId !== '';
      
      const url = isEdit ? `/edit-event-ajax/${eventId}/` : `{% url "main:add_event_ajax" %}`;
      const formData = new FormData(eventForm);

      try {
          const response = await fetch(url, {
              method: 'POST',
              body: formData
          });

          if (!response.ok) {
              throw new Error(`Server returned: ${response.status} (${response.statusText})`);
          }

          const result = await response.json();

          if (result.status === 'success') {
              hideEventModal();
              document.dispatchEvent(new CustomEvent('event-changed'));

          } else {
              let errorHtml = '<div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700"><ul>';
              for (const field in result.errors) {
                  errorHtml += `<li><strong>${field}:</strong> ${result.errors[field][0]}</li>`;
              }
              errorHtml += '</ul></div>';
              formErrors.innerHTML = errorHtml;
              formErrors.classList.remove('hidden');
          }
      } catch (error) {
          console.error('Terjadi kesalahan yang tidak terduga.', error);
          
          formErrors.innerHTML = `<div class="px-4 py-3 rounded text-sm border bg-red-50 border-red-200 text-red-700"><strong>Error:</strong> ${error.message}. Cek console (F12) dan terminal Django Anda.</div>`;
          formErrors.classList.remove('hidden');
      }
  });
</script>