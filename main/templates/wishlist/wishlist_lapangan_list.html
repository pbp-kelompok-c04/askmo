{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Wishlist - Lapangan - ASKMO</title>

<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
    .main-content-container {
        padding-top: 70px;
    }

    main { padding: 20px 40px; max-width: 1200px; margin: 0 auto; }
    h1 { font-size: 40px; font-weight: 700; margin-bottom: 30px; text-align: center; }
    .card-container { 
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px; 
    }

    @media (min-width: 620px) {
        .card-container {
            grid-template-columns: repeat(auto-fit, 300px); 
            justify-content: center; 
        }
    }
    .card { background-color: #1A1A1A; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .card img { width: 100%; height: 180px; object-fit: cover; }
    .card-body { padding: 15px; display: flex; flex-direction: column; min-height: 150px;}
    .card h3 { font-size: 1.25rem; margin: 10px 0 5px; flex-grow: 1;}
    .card p { color: #ccc; font-size: 0.95rem; margin-bottom: 5px; }
    .card-rating { color: #FFD700; }
    .card-buttons { display: flex; justify-content: space-between; margin-top: 15px; margin-top: auto}
    .btn { padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: 600; cursor: pointer; transition: background-color 0.2s; border: none; }
    .btn-secondary { background-color: gray; color: white; }
    .btn-primary { background-color: #571E88; color: white; }
    .btn-primary:hover { background-color: #7A3EAA; }
    .no-data-message { color: #888; font-size: 1.2em; text-align: center; width: 100%; margin-top: 50px; grid-column: 1 / -1; }

    #modal-overlay {
        display: none; 
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        justify-content: center;
        align-items: center;
        z-index: 1000;
        padding: 20px;
        overflow-y: auto;
    }

    #modal-content {
        background: #1A1A1A; 
        border-radius: 20px;
        width: 100%;
        max-width: 600px; 
        max-height: 90vh; 
        overflow-y: auto; 
        color: #fff;
        position: relative;
        border: 1px solid #333;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    #modal-close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        background: none;
        border: none;
        color: #888;
        font-size: 1.8rem;
        cursor: pointer;
        transition: color 0.2s;
    }
    #modal-close-btn:hover {
        color: #fff;
    }

    #modal-image {
        width: 100%;
         height: 250px;
         object-fit: cover;
        border-radius: 20px 20px 0 0;
    }

    .modal-body {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    #modal-nama {
        font-size: 2rem;
        font-weight: 700;
        line-height: 1.2;
     }

    .modal-priority-info {
        display: flex;
        flex-direction: column;
        gap: 10px;
        font-size: 1rem;
        color: #CFCFCF;
    }
     
    .modal-priority-info p {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    .modal-priority-info i {
        width: 20px; 
        text-align: center;
        color: #888;
    }
     
    .modal-divider {
        border: 0;
        height: 1px;
        background: #333;
        margin: 10px 0;
    }
   
    .modal-details {
        d: flex;
        flex-direction: column;
        gap: 10px;
    }

    .modal-details h4 {
        font-size: 1.2rem;
        font-weight: 600;
        color: #fff;
        margin-top: 5px;
    }

    .modal-details p {
        font-size: 0.95rem;
        color: #CFCFCF;
        line-height: 1.6;
        white-space: pre-wrap; 
    }

    #modal-kontak-btn {
        display: inline-block;
        text-decoration: none;
        padding: 12px 20px;
        background: #571E88; 
        color: #fff;
        font-weight: 600;
        border-radius: 10px;
         text-align: center;
        margin-top: 10px;
        transition: background 0.2s;
    }
    #modal-kontak-btn:hover {
        background: #7A3EAA;
    }
</style>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div class="fixed top-9 right-9 z-50 hidden md:block">
  <a href="{% url 'main:show_profile' %}">
    <div class="flex items-center space-x-2 px-4 py-2 text-[#CFCFCF] text-sm font-medium">
      <span>{{ user.username }}</span>
    </div>
  </a>
</div>

<div class="fixed top-9 left-9 z-50 hidden md:block">
    <a href="{% url 'main:show_profile' %}" class="text-gray-300 hover:text-white font-medium transition-colors">
    ‚Üê Kembali ke Profile
    </a>
</div>

<div class="main-content-container"> 
    <main>
        <h1 style="font-size: 40px; margin-bottom: 30px;"><b>Wishlist - Lapangan</b></h1>

        <div class="card-container">
            {% for lapangan in lapangan_list %}
            <div class="card">
                {% if lapangan.thumbnail %}
                    <img src="{{ lapangan.thumbnail }}" alt="Foto {{ lapangan.nama }}" id="card-image-{{ lapangan.id }}">
                {% else %}
                    <img src="https://via.placeholder.com/300x180.png?text=No+Image" alt="Foto tidak tersedia" id="card-image-{{ lapangan.id }}">
                {% endif %}

                <div class="card-body">
                    <h3>{{ lapangan.nama }}</h3>
                     <p> {{lapangan.kecamatan}} </p>
                    <p class="card-rating">
                        <i class="fas fa-star" style="margin-right: 5px;"></i> 
                        {{ lapangan.rating|floatformat:1 }}
                    </p>

                    <div class="card-buttons">
                        <button 
                            style="background-color: #333;"
                            type="button" 
                            class="btn btn-wishlist" 
                            data-item-id="{{ lapangan.id }}" 
                            data-item-type="lapangan"
                            onclick="toggleWishlist('{{ lapangan.id }}', 'lapangan')"> 
                            <i id="bookmark-{{ lapangan.id }}" 
                                class="fas fa-bookmark is-saved" 
                                style="color: rgb(255, 228, 120)">
                            </i>
                        </button>

                        <a href="tel:{{ lapangan.kontak }}" class="btn btn-secondary">Hubungi</a>
 
                        <button 
                            type="button" 
                            class="btn btn-primary" 
                            onclick="showDetail('{{ lapangan.id }}')">
                            Detail
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
                <p class="no-data-message">Tidak ada lapangan di wishlist Anda.</p>
            {% endfor %}
        </div>
    </main>
</div>

<div id="modal-overlay" onclick="checkCloseModal(event)">
    <div id="modal-content">
        <button id="modal-close-btn" onclick="hideDetail()">&times;</button>
        <img id="modal-image" src="https://via.placeholder.com/600x250.png?text=Loading..." alt="Foto Lapangan">
        <div class="modal-body">
        <h2 id="modal-nama">Nama Lapangan</h2>

            <div class="modal-priority-info">
                <p><i class="fas fa-map-marker-alt"></i> <span id="modal-kecamatan">Kecamatan</span></p>
                <p><i class="fas fa-star"></i> <span id="modal-rating">5.0</span></p>
                <p><i class="fas fa-running"></i> <span id="modal-olahraga">Jenis Olahraga</span></p>
                <p><i class="fas fa-tag"></i> <span id="modal-tarif">Rp 00.000</span></p>
                <p><i class="fas fa-undo-alt"></i> <span id="modal-refund">Status Refund</span></p>
            </div>

            <hr class="modal-divider">

            <div class="modal-details">
                <h4>Alamat</h4>
                <p id="modal-alamat">Detail Alamat Lapangan</p>
            </div>

            <div class="modal-details">
                <h4>Deskripsi</h4>
                    <p id="modal-deskripsi">Deskripsi Lapangan</p>
            </div>

            <div class="modal-details">
                <h4>Fasilitas</h4>
                <p id="modal-fasilitas">Daftar Fasilitas</p>
            </div>

            <div class="modal-details">
                <h4>Peraturan</h4>
                <p id="modal-peraturan">Daftar Peraturan</p>
            </div>

            <a href="#" id="modal-kontak-btn">Hubungi Sekarang</a>
        </div>
    </div>
</div>

<script>
    const modalOverlay = document.getElementById('modal-overlay');
    const modalNama = document.getElementById('modal-nama');
    const modalAlamat = document.getElementById('modal-alamat');
    const modalKecamatan = document.getElementById('modal-kecamatan');
    const modalRating = document.getElementById('modal-rating');
    const modalOlahraga = document.getElementById('modal-olahraga');
    const modalTarif = document.getElementById('modal-tarif');
    const modalRefund = document.getElementById('modal-refund');
    const modalKontakBtn = document.getElementById('modal-kontak-btn');
    const modalImage = document.getElementById('modal-image');
    const modalDeskripsi = document.getElementById('modal-deskripsi');
    const modalFasilitas = document.getElementById('modal-fasilitas');
    const modalPeraturan = document.getElementById('modal-peraturan');

    function getCookie(name) {
        let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function toggleWishlist(itemId, itemType) {
        removeAndReload(itemId, itemType);
    }

    async function removeAndReload(itemId, itemType) {
        const isConfirmed = confirm("Anda yakin ingin menghapus Lapangan ini dari Wishlist?");
        if (!isConfirmed) return;

        try {
            const response = await fetch('{% url "main:toggle_wishlist" %}', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    item_id: itemId,
                    item_type: itemType
                })
            });

            if (!response.ok) throw new Error('Gagal menghubungi server.');

            const data = await response.json();

            if (data.status === 'removed') {
                alert(`Lapangan berhasil dihapus dari Wishlist!`);
                window.location.reload(); 
            } else {
                alert("Gagal menghapus Lapangan dari Wishlist.");
            }

        } catch (error) {
            console.error("Error removing from wishlist:", error);
            alert("Terjadi kesalahan saat menghapus wishlist.");
        }
    }

    async function showDetail(lapanganId) {
        try {
            const response = await fetch(`/json/${lapanganId}/`); 
            if (!response.ok) throw new Error('Data not found');

            const data = await response.json();

            modalNama.textContent = data.nama;
            modalAlamat.textContent = data.alamat || 'Tidak ada info alamat.';
            modalKecamatan.textContent = data.kecamatan || 'Tidak ada info kecamatan.';
            modalRating.textContent = `${parseFloat(data.rating).toFixed(1)}`;
             modalOlahraga.textContent = data.olahraga;

            const tarif = parseFloat(data.tarif_per_sesi);
            modalTarif.textContent = `Rp ${!isNaN(tarif) ? tarif.toLocaleString('id-ID') : 'N/A'}`;

            modalRefund.textContent = data.refund ? 'Bisa Refund' : 'Tidak Bisa Refund';

            if (data.kontak) {
                modalKontakBtn.href = `tel:${data.kontak}`;
                modalKontakBtn.style.display = 'inline-block';
            } else {
                modalKontakBtn.style.display = 'none';
            }
     
            modalImage.src = data.thumbnail || 'https://via.placeholder.com/600x250.png?text=No+Image';

            modalDeskripsi.textContent = data.deskripsi || 'Tidak ada deskripsi.';
            modalFasilitas.textContent = data.fasilitas || 'Tidak ada info fasilitas.';
            modalPeraturan.textContent = data.peraturan || 'Tidak ada info peraturan.';

            modalOverlay.style.display = 'flex';

        } catch (error) {
            console.error("Error fetching detail:", error);
            alert("Gagal memuat detail lapangan.");
        }
    }

    function hideDetail() {
        modalOverlay.style.display = 'none';
    }

    function checkCloseModal(event) {
        if (event.target === modalOverlay) {
            hideDetail();
        }
    }
</script>

{% endblock content %}